<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session-Based Multi-User Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .session-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }
        .button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #1976d2;
        }
        .button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .status-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .session-list {
            background: #fff3e0;
            border: 1px solid #ff9800;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #f44336;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #4caf50;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            border-bottom-color: #2196f3;
            background: #e3f2fd;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Session-Based Multi-User Demo</h1>
        
        <div class="session-info">
            <h3>Current Session</h3>
            <div id="sessionInfo">No session created</div>
            <button class="button" onclick="createNewSession()">Create New Session</button>
            <button class="button" onclick="loadExistingSession()">Load Existing Session</button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">Upload & Process</button>
            <button class="tab" onclick="switchTab('sessions')">All Sessions</button>
            <button class="tab" onclick="switchTab('testing')">Multi-User Testing</button>
        </div>

        <!-- Upload and Process Tab -->
        <div id="uploadTab" class="tab-content active">
            <h3>File Upload and Processing</h3>
            
            <div class="input-group">
                <label for="fileInput">Select NIfTI file:</label>
                <input type="file" id="fileInput" accept=".nii,.nii.gz">
                <button class="button" onclick="uploadFile()">Upload File</button>
            </div>

            <div class="input-group">
                <label>Mark Test Points:</label>
                <button class="button" onclick="markRandomPoints()">Mark 3 Random Points</button>
                <button class="button" onclick="clearPoints()">Clear All Points</button>
            </div>

            <div class="input-group">
                <button class="button" onclick="runSegmentation()">Run Segmentation</button>
                <button class="button" onclick="getStatus()">Get Status</button>
            </div>

            <div id="status" class="status-box"></div>
        </div>

        <!-- Sessions Tab -->
        <div id="sessionsTab" class="tab-content">
            <h3>Session Management</h3>
            <button class="button" onclick="listAllSessions()">Refresh Session List</button>
            <div id="sessionsList" class="session-list"></div>
        </div>

        <!-- Multi-User Testing Tab -->
        <div id="testingTab" class="tab-content">
            <h3>Multi-User Testing</h3>
            <p>This tab demonstrates how multiple users can work simultaneously:</p>
            
            <button class="button" onclick="simulateMultipleUsers()">Simulate 3 Concurrent Users</button>
            <button class="button" onclick="testSessionIsolation()">Test Session Isolation</button>
            
            <div id="testResults" class="status-box"></div>
        </div>
    </div>

    <script>
        class SessionManager {
            constructor() {
                this.sessionId = localStorage.getItem('currentSessionId');
                this.baseUrl = 'http://localhost:8000';
            }

            async createSession() {
                try {
                    const response = await fetch(`${this.baseUrl}/api/session`, {
                        method: 'POST'
                    });
                    const data = await response.json();
                    this.sessionId = data.session_id;
                    localStorage.setItem('currentSessionId', this.sessionId);
                    this.updateSessionInfo();
                    return this.sessionId;
                } catch (error) {
                    this.showError('Failed to create session: ' + error.message);
                }
            }

            setSession(sessionId) {
                this.sessionId = sessionId;
                localStorage.setItem('currentSessionId', sessionId);
                this.updateSessionInfo();
            }

            getHeaders() {
                const headers = { 'Content-Type': 'application/json' };
                if (this.sessionId) {
                    headers['X-Session-ID'] = this.sessionId;
                }
                return headers;
            }

            async apiCall(endpoint, options = {}) {
                const headers = { ...this.getHeaders(), ...options.headers };
                const url = `${this.baseUrl}${endpoint}`;
                
                try {
                    const response = await fetch(url, { ...options, headers });
                    const data = await response.json();
                    return { success: response.ok, data, response };
                } catch (error) {
                    return { success: false, error: error.message };
                }
            }

            updateSessionInfo() {
                const sessionInfoDiv = document.getElementById('sessionInfo');
                if (this.sessionId) {
                    sessionInfoDiv.innerHTML = `
                        <strong>Session ID:</strong> ${this.sessionId}<br>
                        <small>Stored in localStorage</small>
                    `;
                } else {
                    sessionInfoDiv.innerHTML = 'No session created';
                }
            }

            showMessage(message, type = 'info') {
                const statusDiv = document.getElementById('status');
                const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
                statusDiv.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
                statusDiv.scrollTop = statusDiv.scrollHeight;
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }
        }

        const sessionManager = new SessionManager();

        // Initialize on page load
        window.onload = function() {
            sessionManager.updateSessionInfo();
        };

        async function createNewSession() {
            await sessionManager.createSession();
            sessionManager.showSuccess('New session created');
        }

        function loadExistingSession() {
            const sessionId = prompt('Enter session ID:');
            if (sessionId) {
                sessionManager.setSession(sessionId);
                sessionManager.showSuccess('Session loaded');
            }
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                sessionManager.showError('Please select a file');
                return;
            }

            if (!sessionManager.sessionId) {
                await sessionManager.createSession();
            }

            const formData = new FormData();
            formData.append('file', file);

            try {
                const headers = {};
                if (sessionManager.sessionId) {
                    headers['X-Session-ID'] = sessionManager.sessionId;
                }

                const response = await fetch(`${sessionManager.baseUrl}/api/upload`, {
                    method: 'POST',
                    body: formData,
                    headers: headers
                });

                const result = await response.json();
                if (response.ok) {
                    sessionManager.showSuccess(`File uploaded: ${JSON.stringify(result, null, 2)}`);
                } else {
                    sessionManager.showError(`Upload failed: ${result.detail}`);
                }
            } catch (error) {
                sessionManager.showError('Upload error: ' + error.message);
            }
        }

        async function markRandomPoints() {
            if (!sessionManager.sessionId) {
                sessionManager.showError('No session available');
                return;
            }

            for (let i = 0; i < 3; i++) {
                const pointData = {
                    axis: 2,
                    slice_index: Math.floor(Math.random() * 50) + 10,
                    point: {
                        x: Math.floor(Math.random() * 100) + 50,
                        y: Math.floor(Math.random() * 100) + 50
                    }
                };

                const result = await sessionManager.apiCall('/api/mark_point', {
                    method: 'POST',
                    body: JSON.stringify(pointData)
                });

                if (result.success) {
                    sessionManager.showSuccess(`Point ${i + 1} marked: ${JSON.stringify(result.data)}`);
                } else {
                    sessionManager.showError(`Failed to mark point ${i + 1}: ${result.error || result.data.detail}`);
                }
            }
        }

        async function clearPoints() {
            const result = await sessionManager.apiCall('/api/points', { method: 'DELETE' });
            
            if (result.success) {
                sessionManager.showSuccess('Points cleared: ' + JSON.stringify(result.data));
            } else {
                sessionManager.showError('Failed to clear points: ' + (result.error || result.data.detail));
            }
        }

        async function runSegmentation() {
            sessionManager.showMessage('Starting segmentation...');
            const result = await sessionManager.apiCall('/api/run_segmentation', { method: 'POST' });
            
            if (result.success) {
                sessionManager.showSuccess('Segmentation completed: ' + JSON.stringify(result.data, null, 2));
            } else {
                sessionManager.showError('Segmentation failed: ' + (result.error || result.data.detail));
            }
        }

        async function getStatus() {
            const result = await sessionManager.apiCall('/api/status');
            
            if (result.success) {
                sessionManager.showMessage('Status: ' + JSON.stringify(result.data, null, 2));
            } else {
                sessionManager.showError('Failed to get status: ' + (result.error || result.data.detail));
            }
        }

        async function listAllSessions() {
            try {
                const response = await fetch(`${sessionManager.baseUrl}/api/sessions`);
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                if (data.sessions && data.sessions.length > 0) {
                    sessionsList.innerHTML = '<h4>Active Sessions:</h4>' + 
                        data.sessions.map(session => `
                            <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                                <strong>ID:</strong> ${session.session_id}<br>
                                <strong>Created:</strong> ${new Date(session.created_at).toLocaleString()}<br>
                                <strong>Last Activity:</strong> ${new Date(session.last_activity).toLocaleString()}<br>
                                <strong>NIfTI Loaded:</strong> ${session.nifti_loaded}<br>
                                <strong>Points:</strong> ${session.total_points}<br>
                                <button class="button" onclick="sessionManager.setSession('${session.session_id}')">Switch to This Session</button>
                            </div>
                        `).join('');
                } else {
                    sessionsList.innerHTML = '<p>No active sessions found.</p>';
                }
            } catch (error) {
                sessionManager.showError('Failed to list sessions: ' + error.message);
            }
        }

        async function simulateMultipleUsers() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = '<h4>Simulating 3 concurrent users...</h4>';
            
            // Create 3 different session managers
            const users = [];
            for (let i = 0; i < 3; i++) {
                const user = new SessionManager();
                user.sessionId = null; // Force new session creation
                await user.createSession();
                users.push(user);
                testResults.innerHTML += `<p>User ${i + 1} created session: ${user.sessionId}</p>`;
            }
            
            // Simulate concurrent operations
            testResults.innerHTML += '<h5>Running concurrent operations...</h5>';
            
            // Each user marks different numbers of points
            const promises = users.map(async (user, index) => {
                const numPoints = index + 2; // 2, 3, 4 points respectively
                for (let i = 0; i < numPoints; i++) {
                    const pointData = {
                        axis: 2,
                        slice_index: 32,
                        point: { x: 50 + i * 10, y: 50 + i * 10 }
                    };
                    await user.apiCall('/api/mark_point', {
                        method: 'POST',
                        body: JSON.stringify(pointData)
                    });
                }
                return { user: index + 1, points: numPoints, sessionId: user.sessionId };
            });
            
            const results = await Promise.all(promises);
            
            testResults.innerHTML += '<h5>Results:</h5>';
            results.forEach(result => {
                testResults.innerHTML += `<p>User ${result.user}: ${result.points} points marked in session ${result.sessionId}</p>`;
            });
            
            testResults.innerHTML += '<p><strong>✅ Multi-user simulation completed!</strong></p>';
        }

        async function testSessionIsolation() {
            const testResults = document.getElementById('testResults');
            testResults.innerHTML = '<h4>Testing session isolation...</h4>';
            
            // Create two separate sessions
            const user1 = new SessionManager();
            const user2 = new SessionManager();
            
            user1.sessionId = null;
            user2.sessionId = null;
            
            await user1.createSession();
            await user2.createSession();
            
            testResults.innerHTML += `<p>User 1 session: ${user1.sessionId}</p>`;
            testResults.innerHTML += `<p>User 2 session: ${user2.sessionId}</p>`;
            
            // User 1 marks 2 points, User 2 marks 4 points
            for (let i = 0; i < 2; i++) {
                await user1.apiCall('/api/mark_point', {
                    method: 'POST',
                    body: JSON.stringify({
                        axis: 2,
                        slice_index: 32,
                        point: { x: 50 + i * 10, y: 50 + i * 10 }
                    })
                });
            }
            
            for (let i = 0; i < 4; i++) {
                await user2.apiCall('/api/mark_point', {
                    method: 'POST',
                    body: JSON.stringify({
                        axis: 2,
                        slice_index: 32,
                        point: { x: 30 + i * 10, y: 30 + i * 10 }
                    })
                });
            }
            
            // Check status for both users
            const status1 = await user1.apiCall('/api/status');
            const status2 = await user2.apiCall('/api/status');
            
            testResults.innerHTML += `<p>User 1 points: ${status1.data.total_points}</p>`;
            testResults.innerHTML += `<p>User 2 points: ${status2.data.total_points}</p>`;
            
            if (status1.data.total_points === 2 && status2.data.total_points === 4) {
                testResults.innerHTML += '<p><strong>✅ Session isolation test PASSED!</strong></p>';
            } else {
                testResults.innerHTML += '<p><strong>❌ Session isolation test FAILED!</strong></p>';
            }
        }

        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
